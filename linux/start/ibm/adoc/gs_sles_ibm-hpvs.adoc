:docinfo:
include::./common_docinfo_vars.adoc[]

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// General comments
// Keep in mind that this is a "getting started" guide and the
//   audience that you are trying to reach.
// Leverage ASCIIDoc features to make this document readable and usable:
//   - Text highlights (follow SUSE style guides)
//   - Admonitions (i.e., NOTE, TIP, IMPORTANT, CAUTION, WARNING)
//   - Code blocks
//   - Lists (ordered and unordered, as appropriate)
//   - Links (to other resources)
//   - Images
//     - Place image files under the ./media directory tree
//       (e.g., ./media/src/svg, ./media/src/png)
//     - Format preference: svg > png > jpg
//     - Consolidate images wherever possible
//       (i.e., don't use two images when one conveys the message)
//   - Use sections and subsections to organize and group related
//     steps.
// 
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Variables & Attributes
//
// NOTES:
// 1. Update variables below and adjust docbook file accordingly.
// 2. Comment out any variables/attributes not used.
// 3. Follow the pattern to include additional variables.
//
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// organization - do NOT modify
// -
:trd: Technical Reference Documentation
:type: Getting Started
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// document
// -
:title: Confidential Computing with SUSE Linux Enterprise Base Container Images
:subtitle: Using the IBM Hyper Protect Platform

:product1: SLE BCI
:product1_full: SUSE Linux Enterprise Base Container Images
:product1_url: https://www.suse.com/products/base-container-images/
:product2: SLES-Z
:product2_full: SUSE Linux Enterprise Server on IBM Z and LinuxONE
:product2_version: 15
:product2_url: https://www.suse.com/products/systemz/
:product3: IBM HPVS
:product3_full: IBM Hyper Protect Virtual Servers
:product3_url: https://www.ibm.com/products/hyper-protect-virtual-servers 

:usecase:  confidential computing with containers

:executive_summary: Deploy {product1_full} into a hybrid confidential computing environment using {product3_full}.

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// contributor
// specify information about authors, editors, and others here,
// then update docinfo file as appropriate
// -
:author1_firstname: Mike
:author1_surname: Friesenegger
:author1_jobtitle: Solutions Architect
:author1_orgname: SUSE
//:author2_firstname: first (given) name
//:author2_surname: surname
//:author2_jobtitle: job title
//:author2_orgname: organization affiliation
:editor1_firstname: Terry
:editor1_surname: Smith
:editor1_jobtitle: Director of Global Partner Solutions
:editor1_orgname: SUSE
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// miscellaneous
// define any additional variables here for use within the document
// -
:hpvs_onprem: {product3_full}
:hpvs_onprem_ver: 2.1.x
:hpvs_cloud: IBM Cloud Hyper Protect Virtual Servers


// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


= {title}: {subtitle}



== Introduction

=== Motivation

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Provide a motivation for the document in 2-4 sentences to identify:
//   - what the document is about
//   - why it may be of interest to the reader (e.g., a use case)
//   - what products are being highlighted
// Include an approved SUSE | Partner logo lock-up if possible
// Include any additional, relevant details
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

Confidential computing focuses on securing your data through technical assurance which guarantees that a cloud operator cannot access your data.
Confidential computing can also be used within your datacenter or within the data center of a service provider to protect your data.
Hardware capabilities within IBM Z(R) and LinuxONE systems provide the trusted execution environment that protects your data-in-use.
The confidential computing workload is built on SUSE Linux Enterprise Base Container images and deployed securely using the IBM Hyper Protect Platform.

=== Scope

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Specify what this guide covers in no more than 2 sentences.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

In this guide you deploy a containerized confidential computing workload to an IBM Z and LinuxOne trusted execution environment using a SUSE Linux Enterprise Base Container Image (SLE BCI) and the IBM Hyper Protect Platform.


=== Audience

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Identify for whom this document is intended, perhaps with:
//   - topics of interests (e.g., machine learning, security, etc.)
//   - job roles (e.g., developer, administrator, platform architect, etc.)
//   - required skills
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

This guide can help architects and developers evaluate the effort to deploy containerized workloads into a confidential computing environment.
The required skills include a basic knowledge of container images, Docker Compose, and confidential computing concepts, such as attestation.


=== Acknowledgements

Nicolas Mäding +
Senior Product Manager - IBM HyperProtect Platform +
<additional details needed>

Dirk Herrendörfer +
Software Developer +
<additional details needed>

== Prerequisites

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Identify minimum requirements (prerequisites) the reader
// would need in order to follow the steps of this guide.
// - Link to existing resources whenever possible.
// - Keep this section brief but elaborate as needed.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

You are highly encouraged to start this journey using https://cloud.ibm.com/docs/vpc?topic=vpc-about-se#about-hyper-protect-virtual-servers-for-vpc[Confidential computing with LinuxONE] using IBM Cloud Hyper Protect Virtual Servers for Virtual Private Cloud (VPC).

The infrastructure for the trusted execution environment needed for HPVS is already set up and available as an easy-to-use service in IBM Cloud.
If you would like to use IBM Cloud Hyper Protect Virtual Servers for VPC then all you need is an IBM Cloud https://cloud.ibm.com/docs/account?topic=account-accounts#paygo[Pay-As-You-Go account].

On-premises confidential computing deployments use https://www.ibm.com/products/hyper-protect-virtual-servers[IBM Hyper Protect Virtual Servers].
The technology used in IBM Hyper Protect Virtual Servers is the same as IBM Cloud Hyper Protect Virtual Servers for VPC but you will need to prepare the required infrastructure before deploying a workload.
The following high level infrastructure prerequisites are needed if you would like to use IBM Hyper Protect Virtual Servers:

* An IBM Z(R) or LinuxONE system
** IBM z16 (all models)
** IBM z15 (all models)
** IBM LinuxONE 4
** IBM LinuxONE III
* Feature Code 115 Secure Execution for Linux
* Logical parition (LPAR) running the latest SUSE Linux Enterprise Server version, which is an IBM Secure Execution enabled Kernel-based Virtual Machine (KVM) host
* IBM Hyper Protect Virtual Servers {hpvs_onprem_ver}
** A https://www.ibm.com/docs/en/hpvs/2.1.x?topic=trial-program[trial program] for IBM Hyper Protect Virtual Servers and Crypto Express Network API for Secure Execution Enclaves is available from IBM.

Detailed system requirements can be found in the https://www.ibm.com/docs/en/hpvs/2.1.x?topic=servers-system-requirements[Hyper Protect Virtual Servers {hpvs_onprem_ver} documentation].


== Technical overview

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Provide a technical overview of the solution.
// - Identify components.
// - Describe how the components fit together.
//   Leverage diagrams as appropriate, including (but not limited to):
//   - component architecture
//   - data flow diagram
//   - workflow diagram
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


image::hpvs-architecture.svg[IBM Hyper Protect Platform architecture, scaledwidth="75%", align="center"]

The IBM Hyper Protect Platform architecture is illustrated in this diagram at a high level with the components that comprise the confidential computing environment in IBM Cloud (on the left) as well as on-premises or in a hosted datacenter (on the right).
The architectural similarities provide a hybrid deployment model that gives you the flexibility to easily target the location of your workload depending on business requirements.

The components of the IBM Hyper Protect Platform include:

* https://www.ibm.com/docs/en/linux-on-systems?topic=virtualization-introducing-secure-execution-linux[Secure Execution for Linux]
//
+
This z/Architecture(R) security technology is introduced with IBM z15™ and LinuxONE III.
//
+
With Secure Execution for Linux, no hardware administrator, KVM code, or KVM administrator can access the data in a KVM virtual machine that was started as an IBM Secure Execution guest.

* https://www.ibm.com/docs/en/zos/2.4.0?topic=configuration-logical-partitions[Logical partition] (LPAR)
//
+
Multiple LPARs can share the resources of a single, physical system.
//
+
The KVM host runs in an LPAR, which, in practice, is equivalent to an independent server running its own operating system.
+
[NOTE]
====
* IBM Cloud Hyper Protect Virtual Servers for VPC use an IBM provided KVM host.

* SUSE Linux Enterprise Server can be used for on-premises and hosted datacenter deployments as a supported KVM host for IBM Hyper Protect Virtual Servers {hpvs_onprem_ver}.
====

* KVM virtual machine
//
+
A KVM virtual machine can be started as a Secure Execution guest where memory protection is enforced, preventing unauthorized access to in-memory data.
//
+
Multiple KVM virtual machines can be started as Secure Execution guests.
If not started as a Secure Execution guest, the virtual machine memory protection is not enforced.

* IBM Hyper Protect Container Runtime (HPCR)
//
+
The IBM Hyper Protect Container Runtime (HPCR) provides the environment for containers to be started and run confidentially.
The HPCR is a KVM virtual machine QCOW2 disk image file specifically built to start as a Secure Execution guest.
The HPCR requires input from a contract to pull and start containerized workloads from a customer or ISV provided container registry.
+
[NOTE]
====
* The HPCR virtual machine protects data-at-rest by encrypting the root disk as well as encrypting a separate data disk for container workload persisent storage.
* HPCR requires a contract, which is a definition of the workload configuration in YAML format.
The HPCR virtual machine will immediately stop when a contract is missing or invalid.
The contract is critical and is presented in more detail later in this document.
====

* Container images
//
+
Workload container images can be built on SUSE Linux Enterprise Base Container Images (SLE BCI).
//
+
You can run multiple workload containers on a single HPCR Secure Execution guest.

* Logging service
//
+
A logging service is required.
The HPCR virtual machine will immediately stop if logging is not defined in the contract.


=== Workflow

The workflow to prepare, deploy, and manage a confidential container workload in IBM Cloud or on-premises are shown below.  

NOTE: During the draft phase this is a work-in-progress list of steps

// image::hpvs-deployment-workflow.svg[Prepare and deploy confidential container workloads, scaledwidth="75%", align="center"]

[cols=2*,width="100%",options=header]
|===
^| *Cloud deployment*
^| *On-premises deployment*

| Prepare for IBM Cloud Hyper Protect Virtual Servers for VPC
| Prepare for IBM Hyper Protect Services

a|

* <<Create a Virtual Private Cloud (VPC)>>
* <<Set up a logging service for HPVS for VPC provisioning>>

a|

* Verify required hardware and Secure Execution feature code is enabled
* Install and set up LPAR with KVM included in SLES for IBM Z and LinuxONE
* Enable Secure Execution capabilities in KVM
* Download the HPCR image
* Set up a logging service for HPVS provisioning

|===

image::arrow_down_jungle-green-50wide.png[Down arrow, align="center"]

[width="100%"]
|===

| Build, publish, and define a confidential container workload for the IBM Hyper Protect Platform

a|

* <<Build a container image>>
* <<Publish the container image to a registry>>
* <<Define the contract>>

|===

image::arrow_down_jungle-green-50wide.png[Down arrow, align="center"]

[cols=2*,width="100%"]
|===

2+| Deploy a confidential container workload using IBM Hyper Protect Services

a|

* <<Cloud deployment>>

a|

* Deploy a confidential container workload on IBM Hyper Protect Virtual Servers

|===

image::arrow_down_jungle-green-50wide.png[Down arrow, align="center"]

[width="100%"]
|===

| Manage the confidential container workload after deployment

a|

* <<Verify attestation and disk encryption>>
* Recover or upgrade Hyper Protect Services confidential container workloads

|===


== Preparation

Before you can deploy your confidential container workloads, you must prepare your environment.

Follow the steps detailed in <<Cloud preparation>> or <<On-premises preparation>> depending on the infrastructure environment you are using.


=== Cloud preparation

The IBM Cloud Web Console is used in this guide, but it is also possible to perform the same actions using the IBM Cloud CLI or Terraform.

==== Create a Virtual Private Cloud (VPC)

. Log into the https://cloud.ibm.com/[IBM Cloud Web Console].

. In the upper right part of the web console (between __Manage__ and __Help__), select the correct account from the list.

. Select __Navigation Menu__ > __VPC Infrastructure__ > __VPCs__.

. Select the __Region__ from the list.

. Click __Create__.

. Edit __Name__ in the __Details__ section (for example, `vpc-myvpc`).
//
+
Do not change default selections for other items.

. In the __Subnets__ section, click __Edit__ and rename the dynamically named subnets.
//
+
For example, three, regional zones could be named: `sn-myvpc-01`, `sn-myvpc-02`, and `sn-myvpc-03`.

. Click __Create virtual private cloud__.

. Select the __Default security group__ for the newly created VPC.

.. Select __Rules__.

.. Click __Create__ in the __Inbound rules__ section.

.. Under __Create inbound rule__:

... Set __Port min__ to `8443`.

... Set __Port max__ to `8443`.

... Avoid changing any other default settings.

... Click __Create__.

. Select __Network__ > __Floating IPs__.

.. Confirm the correct __Region__ is selected.

.. Click __Reserve__.

... Confirm the __Region__.

... Click __Edit__ if you would like to select a different __Zone__.

... Enter the __Floating IP name__ (for example, `myvpc-paynow-floatip`).

... Click __Reserve__.

. Make a note of the location (zone) within the region and the floating IP address that was assigned.

[IMPORTANT]
====
Do not close the browser window or tab.
====


==== Set up a logging service for HPVS for VPC provisioning

. In a new browser window or tab, log into the https://cloud.ibm.com/[IBM Cloud Web Console].

. Select __Navigation Menu__ > __Observability__ > __Logging__.

. Click __Options__ > __Create__.

. Complete the following in the IBM Log Analysis screen:

.. In __Select a location__, choose the same region that is used for your VPC.

.. Under __Select a pricing plan__, choose a plan.

.. Under __Configure your resource__, set __Service name__ (for example, `IBM Log Analysis`).

.. Click __I have read and agree to the following license agreements__.

.. Click __Create__.

. Click __Open dashboard__ in the IBM Log Analysis page.

. Click __Install Instructions__ (the icon is a question mark inside a circle).

. Select __Add Log Sources__ > __Via Syslog__ side menu, then choose `rsyslog`.

. Make a note of the following items:
+
--
* The ingestion key in the __Your Ingestion key is:__ field.

* The hostname.
+
. View the `/etc/rsyslog.d/22-logdna.conf` configuration file.
. Find the comment line, '# Send messages to LogDNA over TCP using the template'.
. Locate the hostname between `@@` and `:6514`.

--

.. Close the __Add Log Sources__ window.

[IMPORTANT]
====
Do not close the browser window or tab.
====


=== On-premises preparation

NOTE: TO BE COMPLETED


== Build, publish, and define

In this section you prepare a workload container image, publish the container image to a registry, and define the IBM Hyper Protect Services contract that will be used during deployment.
The steps in this section are the same for cloud and on-premises deployments.

You will use the https://cloud.ibm.com/docs/vpc?topic=vpc-financial-transaction-confidential-computing-on-hyper-protect-virtual-server-for-vpc[PayNow Node.js application], which has been already built on a SLE BCI container image and published to a container registry.
The steps are also available if you would like to build the PayNow Node.js application on a SLE BCI container.

See https://mediacenter.ibm.com/media/Confidential+Computing+for+a+financial+transaction+using+Hyper+Protect+Virtual+Server+for+VPC/1_vv3j2oo6[confidential computing in action].
In this demonstration, the PayNow Node.js application shows a financial transaction running without confidential computing and with confidential computing.

=== Build a container image

Building one or more application container images is a necessary step.
The PayNow Node.js application container image has already been built on a SLE BCI container and published to a container registry.
You can go to <<Define the contract>> to use the PayNow Node.js application container image or follow the steps below to build your own image of the PayNow Node.js application.

Access to a Linux on s390x instance is required to build the PayNow Node.js application container image.
These steps will use `git` and `podman` to build and publish the OCI-compliant PayNow Node.js application container image.
An option is to use an IBM Cloud virtual server instance (VSI) for VPC with a SUSE Linux Enterprise Server https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#vs-s390x-supported-os[s390x stock virtual server image] but any Linux distro on s390x with `git` and `podman` is sufficient.

The https://registry.suse.com/bci/nodejs18/index.html[SLE BCI Node.js 18 Container Image] will be the base for the PayNow Node.js application container image.

. Clone the Pay Now Website sources.
+
[source, console]
----
git clone https://github.com/mfriesenegger/paynow-website.git
cd paynow-website
----

. Build the PayNow Node.js application container image.
+
[source, console]
----
podman build -f ./Dockerfile -t slebci-paynow-website
----

. Start the Verify the PayNow Node.js application container.
+
[source, console]
----
podman run -d --rm --name paynow-website -p 8443:8443 localhost/slebci-paynow-website
----
+
You will see similar output.
+
[source, console]
----
6628a61d4e8c427e065c00f140c114e57f0dbd8ddf861752140e43cc77f08d74
----

. Verify the PayNow Node.js application container has started.
+
[source, console]
----
podman ps
----
+
You will see similar output.
+
[source, console]
----
CONTAINER ID  IMAGE                                   COMMAND               CREATED        STATUS            PORTS                   NAMES
6628a61d4e8c  localhost/slebci-paynow-website:latest  /bin/sh -c npm st...  6 seconds ago  Up 5 seconds ago  0.0.0.0:8443->8443/tcp  paynow-website
----

. Stop the running PayNow Node.js application container
+
[source, console]
----
podman stop paynow-website
----
+
You will see similar output.
+
[source, console]
----
6628a61d4e8c427e065c00f140c114e57f0dbd8ddf861752140e43cc77f08d74
----


=== Publish the container image to a registry

Publishing one or more application container images is a necessary step.
The PayNow Node.js application container image has already been built on a SLE BCI container and published to a container registry.
You can go to <<Define the contract>> to use the PayNow Node.js application container image or follow the steps below to publish your own image of the PayNow Node.js application.

Access to the same Linux on s390x instance that built the PayNow Node.js application container image is required to publish the image.
These steps will use `podman` to publish the OCI-compliant PayNow Node.js application container image.
A properly configured github account is required to publish the image to your https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry[GitHub Container registry].

. Tag the PayNow Node.js application container image to your GitHub account.
+
[source, console]
----
podman tag localhost/slebci-paynow-website:latest ghcr.io/<github user>/slebci-paynow-website:latest
----
+
[NOTE]
====
Replace _<github user>_ with your personal github user id.
====

. Log into the GitHub Container registry.
+
[source, console]
----
podman login ghcr.io
Username: <github user>
Password: <github token>
Login Succeeded!
----
+
[NOTE]
====
Replace _<github user>_ with your personal github user id.

Replace _<github token>_ with your personal github access token.
====

. Push the PayNow Node.js application container image.
+
[source, console]
----
podman push ghcr.io/<github user>/slebci-paynow-website:latest
----
+
You will see similar output.
+
[source, console]
----
Getting image source signatures
Copying blob 0ccbad5913ff done  
Copying blob b326be1c2597 done  
Copying blob 33514e467d16 done  
Copying blob bd6fa590b9f7 done  
Copying blob b6d354fd1660 done  
Copying config e71fdf2e7a done  
Writing manifest to image destination
Storing signatures
----
+
[NOTE]
====
Replace _<github user>_ with your personal github user id.
====

. Remove the PayNow Node.js application container image.
+
[source, console]
----
podman rmi ghcr.io/<github user>/slebci-paynow-website:latest
----
+
You will see similar output.
+
[source, console]
----
Untagged: ghcr.io/mfriesenegger/slebci-paynow-website:latest
----

. Confirm that the PayNow Node.js application container image can be pulled from your GitHub Container registry.
+
[source, console]
----
podman pull ghcr.io/<github user>/slebci-paynow-website:latest
----
+
You will see similar output.
+
[source, console]
----
Trying to pull ghcr.io/mfriesenegger/slebci-paynow-website:latest...
Getting image source signatures
Copying blob 433e70b2cea5 skipped: already exists  
Copying blob b12c44df6add skipped: already exists  
Copying blob cc2d0d7ba04c [--------------------------------------] 0.0b / 0.0b
Copying blob a74519fc309a [--------------------------------------] 0.0b / 0.0b
Copying blob ed8b5e1d0d7a [--------------------------------------] 0.0b / 0.0b
Copying config e71fdf2e7a done  
Writing manifest to image destination
Storing signatures
e71fdf2e7ad357830ece71bfc30367f52ab7afa74401d1506cefcb091a62064b
----
+
[NOTE]
====
Replace _<github user>_ with your personal github user id.
====

. Logout of ghcr.io.
+
[source, console]
----
podman logout ghcr.io
----
+
You will see similar output.
+
[source, console]
----
Removed login credentials for ghcr.io
----


=== Define the contract

A contract is a required definition of the workload configuration in YAML format.


. Create a directory and Docker Compose file on a local system.
+
[source, console]
----
mkdir slebci-paynow-website
cd slebci-paynow-website
vi docker-compose.yml
----
+
Use the following if using the pre-built PayNow Node.js application container image.
+
[source, yaml]
----
services:
  paynow:
    image: ghcr.io/mfriesenegger/slebci-paynow-website@sha256:ecb229f68aef81ca4a2b7b5a9eb192081fa2a170e44d9e5a28180bb12682ce5d
    ports:
      - "8080:8080"
      - "8443:8443"
----
+
[IMPORTANT]
====
The goal is to publish the pre-built image to ghcr.io/suse before this document is published to suse.com.
====
+
Or use the following if the PayNow Node.js application container image was built by you and published in your GitHub Container registry.
+
[source, yaml]
----
services:
  paynow:
    image: ghcr.io/<github user>/slebci-paynow-website@<sha256 digest>
    ports:
      - "8080:8080"
      - "8443:8443"
----
+
[NOTE]
====
Replace _<github user>_ with your personal github user id.

Replace _<github digest>_ with the digest information for the in published in your GitHub Container registry.
====

. Create a base64 encoded tar archive[[base64-encoded-archive]].
+
[source, console]
----
tar -czvf - compose.yml | base64 -w0 > compose.b64
----

. Create the contract file.
+
[source, console]
----
vi slebci-paynow-website-contract.yml
----
+
Use the following if using the pre-built PayNow Node.js application container image.
+
[source, yaml]
----
env: |
  type: env
  logging:
    logDNA:
      hostname: <hostname> <1>
      ingestionKey: <ingestionKey>
      port: 6514
workload: |
  type: workload
  compose:
    archive: <archive> <2>
----
+
<1> where <hostname> and <ingestionKey> were noted earlier.
<2> where <archive> was created in the *Create a base64 encoded tar archive*<<base64-encoded-archive>> step.
+
Or use the following if the PayNow Node.js application container image was built by you and published in your GitHub Container registry.
+
[source, yaml]
----
env: |
  type: env
  logging:
    logDNA:
      hostname: <hostname> <1>
      ingestionKey: <ingestionKey>
      port: 6514
workload: |
  type: workload
  auths:
    ghcr.io:
      username: <github user> <2>
      password: <github token>
  compose:
    archive: <archive> <3>
----
+
<1> where <hostname> and <ingestionKey> were noted earlier.
<2> where <github user> and <github token> are from your personal GitHub account. 
<3> where <archive> was created in the *Create a base64 encoded tar archive*<<base64-encoded-archive>> step.

An example contract using the pre-built image is shown below.

[NOTE]
====
The base64 data for the archive item is truncated.
====

[source, yaml]
----
env: |
  type: env
  logging:
    logDNA:
      hostname: syslog-a.ca-tor.logging.cloud.ibm.com
      ingestionKey: e2db535664e682b59101b742d59234da
      port: 6514
workload: |
  type: workload
  compose:
    archive: H4sIAAAAAAAAA+3UzW7bMAwHcJ/zFELucahP2gYG7LjjXkG2mNRoXQdWtrZvP6XBsCyHboeuW7H/
----


== Deploy

The deployment steps differ, depending on whether you are deploying to cloud or to your on-premises environment.
Proceed to either <<Cloud deployment>> or <<On-premises deployment>>.


=== Cloud deployment

For this guide, you use the IBM Cloud Web Console to perform the deployment.
It is also possible to perform a deployment using the IBM Cloud CLI or Terraform.


==== Deploy the workload

Follow these steps to deploy your confidential container workload on IBM Cloud Hyper Protect Virtual Servers for VPC.

. Return to the https://cloud.ibm.com/ Web browser window or tab where you created the VPC.

. Select __Navigation Menu__ > __VPC Infrastructure__ > __Virtual server instances__.

. Confirm that the correct Region is selected.

. Click __Create__.

. Edit the following in __Virtual server for VPC__:

.. Change __Architecture__ to `IBM Z, LinuxONE`.

.. Use the slider under __Confidential computing__ to enable `Run your workoad with an OS and a profile protected by Secure Execution`.

.. Verify that the __Zone__ in __Location__ matches the location (zone) within the region that you noted earlier.

.. Set the __Name__ of the instance to `slebci-paynow-website`.

.. Click __Import user data__ in __User data (optional)__ to select `slebci-paynow-website-contract.yml` from the local system.

.. Click __Create virtual server__.

. Select __Network__ > __Floating IPs__ and complete the following:

.. Click __Actions...__ to the right of the `myvpc-paynow-floatip` entry.

.. Select __Bind__.

.. Select `slebci-paynow-website` in __Resource to bind__.

.. Click __Bind__.

. Select __Compute__ > __Virtual server instances__ and complete the following:

.. Click __Actions...__ to the right of the `slebci-paynow-website` entry.

.. Select __Open serial console__.

.. Watch for the following within the serial console as the instance is being startedr:
+
[source, console]
----
VSI has started successfully.
----


==== Verify the workload is running

Verify that the PayNow application is running by connecting to its Web UI.

. Open a new Web browser window or tab.

. Enter `\https://<floating-ip>:8443`, where <floating-ip> is the floating IP address noted earlier.
+
[NOTE]
====
Your Web browser may display a warning about a insecure connection and a invalid certificate because the application uses a self-signed certificate.
====

. You should see that the PayNow application is running.
+
image::paynow-website.png[PayNow UI, scaledwidth="75%", align="center"]

. Click the __PayNow__ button.

. Enter example PII and credit card information.


==== Review the logs

Review the logs of the IBM Cloud Hyper Protect Virtual Servers for VPC instance for potential issues.

. Return to the https://cloud.ibm.com/ window or tab where you created the logging service.

. Verify that log information is displayed.

. Review the log and find the following:

.. Entries where the `slebci-paynow-website` container image is being pulled from the container registry.

.. Entries where the `slebci-paynow-website` container image being started.
//
+
For example:
+
[listing]
----
slebci-paynow-website hpcr-container info Container compose-paynow-1  Started 
slebci-paynow-website hpcr-container debug Docker compose result: 
slebci-paynow-website hpcr-container info  CONTAINER ID   IMAGE                                         COMMAND                  CREATED         STATUS                  PORTS                                                                                  NAMES 
slebci-paynow-website hpcr-container info cab3993b8eb6   ghcr.io/mfriesenegger/slebci-paynow-website   "/bin/sh -c 'npm sta…"   4 seconds ago   Up Less than a second   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp, 0.0.0.0:8443->8443/tcp, :::8443->8443/tcp   compose-paynow-1 
slebci-paynow-website hpcr-container debug Container service completed successfully
----
+
[NOTE]
====
Date and time stamps for entries have been removed from the logging output examples shown here.
====

.. Entries for PayNow application API calls.
//
+
For example:
+
[listing]
----
slebci-paynow-website compose-paynow-1 info GET /api/v1/transactions 
slebci-paynow-website compose-paynow-1 info POST /api/v1/transactions 
slebci-paynow-website compose-paynow-1 info GET /api/v1/transactions 
----


=== On-premises deployment

NOTE: TO BE COMPLETED


== Manage

The manage section focuses on the steps in the <<Workflow>> of interacting with the confidential containized workload after deployment.

=== Verify attestation and disk encryption

NOTE: TO BE COMPLETED

== Summary

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Summarize:
// - Motivation (1 sentence)
// - What was covered (1-2 sentences)
// - Next steps (unordered list of 2-4 further learning resources)
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

In this guide, you have been introduced to containized confidential computing with SUSE Linux Enterprise Base Container Images using the IBM Hyper Protect Platform.
The PayNow website application was already built for you on SUSE Linux Enterprise Base Container images.
You deployed the application securely in a confidential computing environment via a workload contract using the IBM Hyper Protect Platform either in the cloud or on-premise.

Now that you have taken your first steps, you are encouraged to learn more about the following.

* Accelerate Application Development with Open, Secure Containers with https://www.suse.com/products/base-container-images/[SUSE Linux Enterprise Base Container Images].
* https://documentation.suse.com/trd/linux/tbd[Build] a trusted PayNow Website container on a SLE Base Container image using https://cloud.ibm.com/docs/vpc?topic=vpc-about-hpsb[IBM Cloud Hyper Protect Secure Build].
* Learn more about Confidential computing with LinuxONE for deployments in https://cloud.ibm.com/docs/vpc?topic=vpc-about-se[IBM Cloud] and https://community.ibm.com/community/user/ibmz-and-linuxone/blogs/nicolas-mding/2022/10/06/ibm-hyper-protect-virtual-servers-v21[on-premises].

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Do not modify below this break.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

++++
<?pdfpagebreak?>
++++


:leveloffset: 0

== Legal notice
include::common_trd_legal_notice.adoc[]

++++
<?pdfpagebreak?>
++++


:leveloffset: 0
include::common_gfdl1.2_i.adoc[]

//end
